<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  1. 相同模块的并发加载问题?
</body>
<script>
  // 模块加载配置
  var config = {
    baseDir: window.location.origin + '/module'
  }

  // loader 模块加载器
  var loader = {
    // 配置
    config: {
      baseDir: window.location.origin + '/module'
    },

    // 缓存
    modules: {},

    // 加载成功
    installed: {},

    status: {},

    deps: {},

    moduleDefined: {},

    // 定义模块
    define: function() {
      let name, fn, deps, args = arguments
      if (args.length === 2) {
        name = args[0]
        fn = args[1]
      } else if (args.length === 3) {
        name = args[0]
        deps = args[1]
        fn = args[2]
      } else {
        throw "invalid params for define function"
      }
      if (deps) {
        if (typeof deps === 'string') deps = [deps]
        this.deps[name] = deps;
        this.moduleDefined[name] = fn
      }
      this.moduleDefined[name] = fn
    },

    // 加载模块
    require: function(name, fn) {
      if (this.modules[name]) {
        // 已经加载成功, 直接从缓存读取
        callback(this.modules[name])
      } else {
        if (this.status[name]) {
          // 加载过了, 但是还未加载成功
          this.installed[name].push(fn)
        } else {
          // 还未加载过
          this.installed[name] = []
          this.installed[name].push(fn)
          this.loadScript(name)
          this.status[name] = true
        }
      }
    },

    // 加载JS文件
    loadScript: function (name) {
      let _this = this
      let script = document.createElement('script')

      script.src = this.config.baseDir + '/' + name + '.js'
      script.onload = function () {
        _this.installed[name].forEach(fn => {
          if (!_this.deps[name]) {
            // 没有依赖
            _this.modules[name] = _this.moduleDefined[name]();
            fn(_this.modules[name])
          } else {
            _this.deps[name].forEach(dep => {
              _this.require(dep, () => {
                _this.modules[name] = _this.moduleDefined[name]();
                _this.installed[name].forEach(fn => fn(_this.modules[name]))
              })
            })
          }
        })
      }
      setTimeout(() => {
        document.body.append(script)
      }, 200)
    }
  }

  loader.require('toolbar', function(toolbar){
    toolbar()
    console.log('require toolbar', Date.now())
  })

  loader.require('lazyload', function(lazyload){
    console.log(Date.now())
    lazyload()
  })

  loader.require('moment', function(moment){
    console.log(moment)
  })
</script>
</html>